package framework;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.StreamCorruptedException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.util.List;
import java.util.Queue;
import java.util.TreeMap;

/*
 * This is a UDP connection manager designed for lossy high throughput data
 */
public class ConnectionManager implements Runnable{
	private int port;
	private DatagramSocket listener;
	
	//transmit port
	private int outPort;
	
	//passed in for concurrent use with a TCP connection
	private TreeMap<String, ConnectionInfoUDP> IPtable;
	
	//input streams, used to rebuild objects from byte arrays
	private ByteArrayInputStream dataInputStream;
	private ObjectInputStream objectStream;
	
	//output streams used to turn objects into byte arrays
	ByteArrayOutputStream dataOutputStream;
	ObjectOutputStream objectOut;
	
	//buffer size (a place to store the bytes coming and going out), set if you receive too much data it will overflow, underflow is not an issue
    byte[] sendDataBuffer;
    byte[] receiveDataBuffer;
    		
	//passed in queue to core processing
	private Queue<gameInputObject> inputData;
	
	//static parameters
	private static final int sendBufferSize = 1024;
	private static final int receiveBufferSize = 1024;

	//TCP UDP conjunction server thread connection
	public ConnectionManager(int newPort, Queue<gameInputObject> sharedQueue, TreeMap<String, ConnectionInfoUDP>  IP)
	{
		try {
			listener = new DatagramSocket(newPort);
			sendDataBuffer = new byte[sendBufferSize];
			receiveDataBuffer = new byte[receiveBufferSize];
			port = newPort;
			outPort = port+3;
			IPtable = IP;
			//initialize serializer streams
			dataOutputStream = new ByteArrayOutputStream();
			objectOut = new ObjectOutputStream(dataOutputStream);
			
			inputData = sharedQueue;
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	//main listener session
	@Override
	public void run() 
	{
		while(true)
		{
			DatagramPacket receivePacket = new DatagramPacket(receiveDataBuffer, receiveDataBuffer.length);
			try {			
				//listen block waiting for object to come in
				listener.receive(receivePacket);
				boolean validIP = false;
				String IPAddress;
				int port;
				//check if incoming packet is from valid IP and update new port for NAT ( need to implement a discard command)
				IPAddress = receivePacket.getAddress().toString().substring(1);
				port = receivePacket.getPort();
				if(IPtable.containsKey(IPAddress))
					validIP = true;
				if(!validIP)
					System.out.println("unrecognized IP...");
				else
				{
					//initialize the streams to read the data
					dataInputStream = new ByteArrayInputStream(receiveDataBuffer);
					objectStream = new ObjectInputStream(dataInputStream);
					
					//turn bytes into object
					receiveData tempHolder =  (receiveData) objectStream.readObject();
					
					//add the new object to queue
					inputData.add( new gameInputObject(tempHolder, IPAddress, port));	
					
					//close up existing stream
					objectStream.close();
					dataInputStream.close();					
				}
			} catch (StreamCorruptedException e) {
				//stream header read error
				System.out.println("corrupted packet or unrecognized object");
			} catch (ClassNotFoundException e) {
				// When rebuilding object fails
				System.out.println("unrecognized object");
			}catch (IOException e) {
					// general network failure
					e.printStackTrace();
				}
		}	
	}
	
	public void dispose() throws IOException
	{
		//close listener and its sessions
		listener.close();
		
		//close serializers
		objectOut.close();
		dataOutputStream.close();
	}
	public void broadcast()
	{
		//implement later
	}
	public void transmitObject(Object c, String IP) throws IOException
	{
		objectOut.writeObject(c);
		sendDataBuffer = dataOutputStream.toByteArray();
		DatagramPacket packet = new DatagramPacket(sendDataBuffer, sendDataBuffer.length, InetAddress.getByName(IP), outPort);
		
		//implement delta encoding here?
		
		listener.send(packet);		
	}
	
}
